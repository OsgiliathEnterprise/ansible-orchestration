---
# tasks file for ansible-orchestration

- name: Requirements
  ansible.builtin.import_tasks: requirements.yml
  when: standalone_role
  tags:
    - standalone

- name: Drain kube
  ansible.builtin.include_tasks: drain-and-reset.yml
  run_once: true
  when:
   - reset_kube
   - kube_masters_group in group_names

- name: Destroying kube
  ansible.builtin.include_tasks: delete-configuration.yml
  when:
   - reset_kube

- name: Install needed packages
  ansible.builtin.import_tasks: prereq.yml

- name: Gather facts
  ansible.builtin.include_tasks: facts.yml

- name: Prepare node for cri
  ansible.builtin.include_tasks: cri.yml

- name: Configur firewall
  ansible.builtin.include_tasks: firewall.yml

# - name: ansible-orchestration | delegate kubernetes ca creation to IPA
#  include_tasks: ipa-certs.yml
#  when:
#   - kube_masters_group in group_names

- name: Create kubernetes configuration directory
  ansible.builtin.file:
    path: "{{ kube_config_folder }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  become: True

- name: Install kube on control plane
  ansible.builtin.include_tasks: kube-install.yml
  when:
    - kube_masters_group in group_names

- name: Install kube on node # Executed sequentially: control plane should be executed first
  ansible.builtin.include_tasks: kube-install.yml
  when:
    - kube_nodes_group in group_names

- name: Give secure permissions to kubernetes admin file
  ansible.builtin.file:
    path: "{{ kube_config_path }}"
    owner: root
    group: root
    mode: '0600'
  when: kube_masters_group in group_names
  become: yes

- name: Create local volumes for nfs mount on nodes
  ansible.builtin.include_tasks: nfs-mountpoints.yml
  when:
    - nfs_mountpoints is defined
    - nfs_mountpoints | length > 0
    - kube_nodes_group in group_names

- name: Create admin user
  ansible.builtin.import_tasks: admin-user.yml
  when:
    - kube_masters_group in group_names
